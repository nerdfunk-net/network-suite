{% extends "base.html" %}

{% block title %}Sync Device - nerdfunk network suite{% endblock %}
{% block page_title %}Device Synchronization{% endblock %}

{% block extra_css %}
<style>
    .search-container {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .device-table {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .table-header {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
    }
    
    .device-row:hover {
        background-color: #f8f9fa;
    }
    
    .sync-button {
        background: linear-gradient(135deg, #28a745, #1e7e34);
        border: none;
        padding: 12px 30px;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .sync-button:hover:not(:disabled) {
        background: linear-gradient(135deg, #1e7e34, #155724);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
    }
    
    .sync-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .pagination-controls {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .pagination-info {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .page-btn {
        border: 1px solid #dee2e6;
        background: white;
        color: #007bff;
        padding: 0.375rem 0.75rem;
        margin: 0 0.125rem;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .page-btn:hover:not(:disabled) {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .page-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .page-btn:disabled {
        background: #f8f9fa;
        color: #6c757d;
        border-color: #dee2e6;
        cursor: not-allowed;
    }
    
    .search-input {
        border: 2px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 12px 16px;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    
    .search-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .loading-spinner {
        display: none;
    }
    
    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .no-devices {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<!-- Search Section -->
<div class="search-container">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h5 class="mb-3">
                <i class="bi bi-search me-2"></i>
                Device Search
            </h5>
            <div class="position-relative">
                <input type="text" 
                       id="deviceSearch" 
                       class="form-control search-input" 
                       placeholder="Enter device name pattern (min. 3 characters)..."
                       autocomplete="off">
                <div class="loading-spinner position-absolute top-50 end-0 translate-middle-y me-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <p class="mb-0 text-muted">
                <i class="bi bi-info-circle me-2"></i>
                Uses regex patterns
            </p>
        </div>
    </div>
</div>

<!-- Devices Table -->
<div class="device-table">
    <div class="table-responsive">
        <table class="table table-hover mb-0" id="devicesTable">
            <thead class="table-header">
                <tr>
                    <th width="5%">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAll">
                            <label class="form-check-label" for="selectAll">
                                <span class="visually-hidden">Select All</span>
                            </label>
                        </div>
                    </th>
                    <th width="20%">Device Name</th>
                    <th width="15%">Primary IP</th>
                    <th width="20%">Location</th>
                    <th width="15%">Role</th>
                    <th width="15%">Status</th>
                </tr>
            </thead>
            <tbody id="devicesTableBody">
                <tr class="no-devices">
                    <td colspan="6">
                        <i class="bi bi-search me-2"></i>
                        Use the search field above to find devices
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Pagination Controls -->
    <div class="pagination-controls d-flex justify-content-between align-items-center">
        <div class="pagination-info">
            Showing <span id="pageStart">0</span> to <span id="pageEnd">0</span> of <span id="totalDevices">0</span> devices
        </div>
        <div class="pagination-buttons">
            <button class="page-btn" id="prevPageBtn" onclick="changePage(-1)">
                <i class="bi bi-chevron-left"></i> Previous
            </button>
            <span id="pageNumbers"></span>
            <button class="page-btn" id="nextPageBtn" onclick="changePage(1)">
                Next <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Sync Section -->
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="bi bi-gear-fill me-2"></i>
                    Sync Configuration
                </h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="statusSelect" class="form-label">Status</label>
                        <select class="form-select" id="statusSelect" required>
                            <option value="">Select status...</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="namespaceSelect" class="form-label">Namespace</label>
                        <select class="form-select" id="namespaceSelect" required>
                            <option value="">Select namespace...</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="syncCables" checked>
                            <label class="form-check-label" for="syncCables">
                                <i class="bi bi-ethernet me-2"></i>Sync Cables
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="syncSoftware" checked>
                            <label class="form-check-label" for="syncSoftware">
                                <i class="bi bi-cpu me-2"></i>Sync Software
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="syncVlans" checked>
                            <label class="form-check-label" for="syncVlans">
                                <i class="bi bi-diagram-3 me-2"></i>Sync VLANs
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="syncVrfs" checked>
                            <label class="form-check-label" for="syncVrfs">
                                <i class="bi bi-router me-2"></i>Sync VRFs
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 d-flex align-items-end">
        <div class="w-100">
            <button type="button" 
                    class="btn sync-button w-100" 
                    id="syncButton" 
                    disabled>
                <i class="bi bi-arrow-clockwise me-2"></i>
                Sync Selected Devices (<span id="selectedCount">0</span>)
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let searchTimeout;
    const deviceSearch = document.getElementById('deviceSearch');
    const devicesTableBody = document.getElementById('devicesTableBody');
    const selectAllCheckbox = document.getElementById('selectAll');
    const syncButton = document.getElementById('syncButton');
    const selectedCountSpan = document.getElementById('selectedCount');
    const loadingSpinner = document.querySelector('.loading-spinner');
    const statusSelect = document.getElementById('statusSelect');
    const namespaceSelect = document.getElementById('namespaceSelect');
    const syncCablesCheckbox = document.getElementById('syncCables');
    const syncSoftwareCheckbox = document.getElementById('syncSoftware');
    const syncVlansCheckbox = document.getElementById('syncVlans');
    const syncVrfsCheckbox = document.getElementById('syncVrfs');
    
    // Pagination variables
    const ITEMS_PER_PAGE = 10;
    let currentPage = 1;
    let allDevices = []; // Store all devices for pagination
    let filteredDevices = []; // Store currently filtered devices
    
    // Load dropdown options
    loadDropdownOptions();
    
    // Initialize pagination controls
    updatePaginationControls(0, 0, 0, 0);
    
    // Make pagination functions globally available
    window.changePage = changePage;
    window.goToPage = goToPage;
    
    // Device search with debounce
    deviceSearch.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 3) {
            return;
        }
        
        loadingSpinner.style.display = 'block';
        
        searchTimeout = setTimeout(() => {
            searchDevices(query);
        }, 20);
    });
    
    // Select all functionality (works on current page)
    selectAllCheckbox.addEventListener('change', function() {
        const currentPageCheckboxes = devicesTableBody.querySelectorAll('.device-checkbox');
        currentPageCheckboxes.forEach(cb => {
            cb.checked = this.checked;
            updateCheckboxSelection(cb);
        });
    });
    
    // Sync button functionality
    syncButton.addEventListener('click', function() {
        const selectedDevices = getSelectedDevices();
        const statusId = statusSelect.value;
        const namespaceId = namespaceSelect.value;
        const syncCables = syncCablesCheckbox.checked;
        const syncSoftware = syncSoftwareCheckbox.checked;
        const syncVlans = syncVlansCheckbox.checked;
        const syncVrfs = syncVrfsCheckbox.checked;
        
        console.log('Sync button clicked:', {
            selectedDevices,
            statusId,
            namespaceId,
            statusSelectValue: statusSelect.value,
            namespaceSelectValue: namespaceSelect.value,
            syncCables,
            syncSoftware,
            syncVlans,
            syncVrfs
        });
        
        if (!statusId || !namespaceId) {
            showAlert('Please select both status and namespace.', 'error');
            return;
        }
        
        if (selectedDevices.length === 0) {
            showAlert('Please select at least one device to sync.', 'error');
            return;
        }
        
        syncSelectedDevices(selectedDevices, statusId, namespaceId, syncCables, syncSoftware, syncVlans, syncVrfs);
    });
    
    // Load dropdown options
    async function loadDropdownOptions() {
        try {
            const response = await fetch('/api/dropdown-data');
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to load dropdown data');
            }
            
            console.log('Dropdown data loaded:', data);
            console.log('Statuses:', data.statuses);
            console.log('Namespaces:', data.namespaces);
            
            populateSelect(statusSelect, data.statuses);
            populateSelect(namespaceSelect, data.namespaces);
            
        } catch (error) {
            console.error('Error loading dropdown options:', error);
            showAlert('Failed to load dropdown options', 'error');
        }
    }    function populateSelect(selectElement, options) {
        // Clear existing options except the first one
        const firstOption = selectElement.querySelector('option[value=""]');
        selectElement.innerHTML = '';
        if (firstOption) {
            selectElement.appendChild(firstOption);
        } else {
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = `Select ${selectElement.id === 'statusSelect' ? 'status' : 'namespace'}...`;
            selectElement.appendChild(defaultOption);
        }
        
        // Determine default values
        const isStatusSelect = selectElement.id === 'statusSelect';
        const defaultName = isStatusSelect ? 'Active' : 'Global';
        let defaultOptionElement = null;
        
        options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.id;
            optionElement.textContent = option.name;
            selectElement.appendChild(optionElement);
            
            // Check if this is the default option we want to select
            if (option.name === defaultName) {
                defaultOptionElement = optionElement;
            }
        });
        
        // Set the default selection
        if (defaultOptionElement) {
            defaultOptionElement.selected = true;
            selectElement.value = defaultOptionElement.value;
        }
    }
    
    // Search devices function
    async function searchDevices(pattern) {
        try {
            const response = await fetch('/api/search-devices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ pattern: pattern })
            });
            
            const data = await response.json();
            loadingSpinner.style.display = 'none';
            
            if (!response.ok) {
                showAlert(data.error || 'Search failed', 'error');
                return;
            }
            
            updateDevicesTable(data.devices);
            
        } catch (error) {
            loadingSpinner.style.display = 'none';
            showAlert('Network error occurred during search', 'error');
            console.error('Search error:', error);
        }
    }
    
    // Update devices table with pagination
    function updateDevicesTable(devices) {
        // Get currently selected devices to preserve them
        const currentlySelected = getSelectedDevices();
        
        // Combine new devices with currently selected devices (to preserve selected ones)
        const selectedDeviceIds = new Set(currentlySelected.map(d => d.id));
        const newDeviceIds = new Set(devices.map(d => d.id));
        
        // Keep selected devices that are not in the new search results
        const selectedToKeep = currentlySelected.filter(device => !newDeviceIds.has(device.id));
        
        // Combine selected devices to keep with new search results
        const combinedDevices = [...selectedToKeep, ...devices];
        
        // Remove duplicates (in case a selected device is also in search results)
        const uniqueDevices = [];
        const seenIds = new Set();
        
        combinedDevices.forEach(device => {
            if (!seenIds.has(device.id)) {
                uniqueDevices.push(device);
                seenIds.add(device.id);
            }
        });
        
        // Store all devices for pagination
        allDevices = uniqueDevices;
        filteredDevices = [...uniqueDevices];
        currentPage = 1; // Reset to first page
        
        renderTablePage();
    }
    
    // Render current page of the table
    function renderTablePage() {
        // Get currently selected devices to preserve selections
        const currentlySelected = getSelectedDevices();
        
        // Calculate pagination values
        const totalDevices = filteredDevices.length;
        const totalPages = Math.ceil(totalDevices / ITEMS_PER_PAGE);
        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, totalDevices);
        const pageDevices = filteredDevices.slice(startIndex, endIndex);
        
        // Clear table except selected rows that are not on current page
        devicesTableBody.innerHTML = '';
        
        // Add devices for current page
        pageDevices.forEach(device => {
            const row = document.createElement('tr');
            row.className = 'device-row';
            row.setAttribute('data-device-id', device.id);
            row.setAttribute('data-device-name', device.name);
            
            // Check if this device was previously selected
            const wasSelected = selectedDevicesGlobal.has(device.id);
            
            row.innerHTML = `
                <td>
                    <div class="form-check">
                        <input class="form-check-input device-checkbox" 
                               type="checkbox" 
                               value="${device.id}"
                               data-device-name="${device.name}"
                               ${wasSelected ? 'checked' : ''}>
                    </div>
                </td>
                <td><strong>${device.name}</strong></td>
                <td>${device.primary_ip4 ? device.primary_ip4.address : '<span class="text-muted">N/A</span>'}</td>
                <td>${device.location ? device.location.name : '<span class="text-muted">N/A</span>'}</td>
                <td>${device.role ? device.role.name : '<span class="text-muted">N/A</span>'}</td>
                <td><span class="status-badge bg-primary text-white">${device.status ? device.status.name : 'Unknown'}</span></td>
            `;
            
            devicesTableBody.appendChild(row);
            
            // Add event listener for checkbox
            const checkbox = row.querySelector('.device-checkbox');
            checkbox.addEventListener('change', () => updateCheckboxSelection(checkbox));
        });
        
        // Show "no devices" message if no devices found
        if (totalDevices === 0) {
            const noDevicesRow = document.createElement('tr');
            noDevicesRow.className = 'no-devices';
            noDevicesRow.innerHTML = `
                <td colspan="6" class="text-center py-4 text-muted">
                    <i class="bi bi-search me-2"></i>
                    No devices found. Try a different search term.
                </td>
            `;
            devicesTableBody.appendChild(noDevicesRow);
        }
        
        // Update pagination controls
        updatePaginationControls(totalDevices, totalPages, startIndex, endIndex);
        
        // Update selected count
        updateSelectedCount();
    }
    
    // Update pagination controls
    function updatePaginationControls(totalDevices, totalPages, startIndex, endIndex) {
        // Update pagination info
        document.getElementById('pageStart').textContent = totalDevices > 0 ? startIndex + 1 : 0;
        document.getElementById('pageEnd').textContent = endIndex;
        document.getElementById('totalDevices').textContent = totalDevices;
        
        // Update previous/next buttons
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
        
        // Update page numbers
        const pageNumbersContainer = document.getElementById('pageNumbers');
        pageNumbersContainer.innerHTML = '';
        
        if (totalPages <= 1) return; // Don't show page numbers for single page
        
        // Calculate page range to show
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        // Adjust start page if we're near the end
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
            pageBtn.textContent = i;
            pageBtn.onclick = () => goToPage(i);
            pageNumbersContainer.appendChild(pageBtn);
        }
    }
    
    // Change page function
    function changePage(direction) {
        const totalPages = Math.ceil(filteredDevices.length / ITEMS_PER_PAGE);
        const newPage = currentPage + direction;
        
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderTablePage();
        }
    }
    
    // Go to specific page
    function goToPage(page) {
        const totalPages = Math.ceil(filteredDevices.length / ITEMS_PER_PAGE);
        
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderTablePage();
        }
    }
    
    // Get selected devices (now works across all pages by storing selections)
    let selectedDevicesGlobal = new Set(); // Store selected device IDs globally
    // Get selected devices (now works across all pages)
    function getSelectedDevices() {
        // Get selected devices from all pages, not just current page
        return allDevices.filter(device => selectedDevicesGlobal.has(device.id));
    }
    
    // Update checkbox event listener to use global selection storage
    function updateCheckboxSelection(checkbox) {
        const deviceId = checkbox.value;
        
        if (checkbox.checked) {
            selectedDevicesGlobal.add(deviceId);
        } else {
            selectedDevicesGlobal.delete(deviceId);
        }
        
        updateSelectedCount();
    }
    
    // Update selected count
    function updateSelectedCount() {
        const selectedDevices = getSelectedDevices();
        const count = selectedDevices.length;
        
        selectedCountSpan.textContent = count;
        syncButton.disabled = count === 0;
        
        // Update select all checkbox state for current page
        const currentPageCheckboxes = devicesTableBody.querySelectorAll('.device-checkbox');
        const currentPageCheckedCount = Array.from(currentPageCheckboxes).filter(cb => cb.checked).length;
        
        if (currentPageCheckboxes.length === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (currentPageCheckedCount === currentPageCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else if (currentPageCheckedCount > 0) {
            selectAllCheckbox.indeterminate = true;
        } else {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        }
    }
    
    // Sync selected devices
    async function syncSelectedDevices(devices, statusId, namespaceId, syncCables, syncSoftware, syncVlans, syncVrfs) {
        syncButton.disabled = true;
        syncButton.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Syncing...';
        
        try {
            const response = await fetch('/api/sync-devices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    devices: devices,
                    status_id: statusId,
                    namespace_id: namespaceId,
                    sync_cables: syncCables,
                    sync_software_version: syncSoftware,
                    sync_vlans: syncVlans,
                    sync_vrfs: syncVrfs
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                showAlert(data.error || 'Sync failed', 'error');
                return;
            }
            
            // Show results
            const summary = data.summary;
            if (summary.successful > 0) {
                showAlert(`Successfully initiated sync for ${summary.successful} of ${summary.total} devices.`, 'success');
            }
            
            if (summary.failed > 0) {
                showAlert(`Failed to sync ${summary.failed} devices. Check logs for details.`, 'warning');
            }
            
            // Log detailed results
            console.log('Sync results:', data.results);
            
        } catch (error) {
            showAlert('Network error occurred during sync', 'error');
            console.error('Sync error:', error);
        } finally {
            syncButton.disabled = false;
            syncButton.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Sync Selected Devices (<span id="selectedCount">0</span>)';
            updateSelectedCount();
        }
    }
    
    // Show alert function
    function showAlert(message, type) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <i class="bi bi-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}-fill me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at top of content
        const content = document.querySelector('.container-fluid');
        content.insertBefore(alertDiv, content.firstChild);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}
